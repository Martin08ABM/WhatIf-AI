---
// Importación la librería jsPDF
import {jsPDF} from "jspdf";

// Import de la URL del backend
const backUrl = import.meta.env.PUBLIC_API_URL;
---
<!-- Sección de la caja de texto -->
<section class="items-center w-full mx-auto]">
  <div
    class="flex flex-col items-center justify-center p-2 sm:w-8/12 mx-auto md:w-2/4 lg:w-1/2 sm:my-5 md:my-10 lg:my-15"
  >
    <p
      class="sm:text-md md:text-lg lg:text-2xl font-bold text-white text-center mb-4 mt-12"
    >
      Crea un nuevo mundo a partir de una frase
    </p>
    <!-- Entrada del formulario -->
    <form
      id="historiaForm"
      class="w-full flex flex-wrap sm:mt-4 md:mt-4 lg:mt-4 justify-center items-center"
    >
      <textarea
        name="promptInput"
        id="promptInput"
        class="border-2 border-neutral-600 rounded-lg sm:text-sm md:text-md lg:text-md text-white w-full min-h-10 max-h-80 input-effects px-4 py-6 mb-4"
        placeholder="Escribe el inicio de tu historia..."></textarea>
      <button
        type="submit"
        class="text-white font-bold text-sm bg-blue-700 hover:bg-blue-500 transition-all ease-in-out duration-300 max-w-60 max-h-18 min-h-8 px-2 py-1 rounded-xl ml-4 min-w-30"
        >Crear historia</button
      >
    </form>
  </div>
  <!-- Div para mostrar el resultado -->
  <div
    class="bg-transparent border-none px-4 py-2 min-h-[50px] text-center justify-center items-center max-w-[70%] sm:mt-auto md:mt-[-4rem] lg:mt-[-4rem] mb-4 mx-auto"
  >
    <p 
      class="text-lg text-white font-bold justify-start items-start text-start"
      id="resultado">
    </p>
    <button 
      id="download"
      class="bg-blue-800 rounded-xl px-2 py-2 font-bold text-lg mt-4 mb-4 text-[14px]">Descargar PDF</button> 
  </div>
</section>

<script>
  // LÓGICA PARA EL ENVIO DEL INICIO DE LA HISTORIA AL BACKEND
  // Listener del formulario
  document.getElementById("historiaForm").addEventListener("submit", async function (event) {
      // Previene que la página se recargue
      event.preventDefault();

      // Obtener el texto del textarea
      const inicioHistoria = document.getElementById("promptInput").value;
      const backUrl = import.meta.env.PUBLIC_API_URL;

      if (inicioHistoria.value === null || inicioHistoria.value === "") {
        alert("Tienes que escribir algo para que tu mensaje se procese");
        console.log(
          "Tienes que escribir algo para que tu mensaje se procese. Te crees que no me voy a dar cuenta que no has escrito nada, buen intento pero hazlo con otro ;)"
        );
        return;
      } else {
        // Prepara los datos para enviar como JSON
        const data = {
          prompt_inicio: inicioHistoria,
        };

        // Muestra un mensaje de "cargando"
        const resultadoDiv = document.getElementById("resultado");
        resultadoDiv.innerText = "Generando continuación...";

        try {
          // Llamada a la API
          const response = await fetch(`${backUrl}/recive-prompt/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data), // Convierte el objeto JS en un string JSON
          });

          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
          }

          // Obtiene la respuesta JSON de la API
          const respuestaApi = await response.json();

          // Muestra la continuación en el div de resultado
          resultadoDiv.innerText = respuestaApi.continuacion;
        } catch (error) {
          console.error("Error al contactar la API:", error);
          resultadoDiv.innerText = `Error: ${error.message}`;
        }
      }
    });

    // LÓGICA PARA LA DESCARGA DE LA HISTORIA COMO PDF
    import { jsPDF } from "jspdf";

    const downloadButton = document.getElementById("download");

    downloadButton?.addEventListener("click", () => {
      // Recoger resultado de la IA
      const text = document.getElementById("resultado")?.innerText || "";

      // Crear un documento PDF
      const doc = new jsPDF();

      // Título del documento
      doc.setFont("helvetica", "bold");
      doc.setFontSize(26);
      doc.text("WhatIf AI", 10, 10);

      // Subtítulo del documento
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.textWithLink("Historia creada en WhatIf AI", 10, 20, {
        url: "https://whatif-ai-7tru.onrender.com",
        target: "_blank",
      });

      // Si el texto es largo, lo dividimos automáticamente en líneas
      const splitText = doc.splitTextToSize(text, 180);

      // Texto de la historia con salto de página automático
      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);
      const lineHeight = 8;
      const margin = 10;
      const pageHeight = doc.internal.pageSize.getHeight() - margin;
      let y = 50;

      splitText.forEach((line) => {
        if (y + lineHeight > pageHeight) {
          doc.addPage();
          y = margin;
        }
        doc.text(line, 10, y);
        y += lineHeight;
      });

      // Guardado del archivo
      doc.save("Descarga-WhatIf_AI.pdf");
    });
</script>

<!-- Estilos del  -->
<style>
  .input-effects {
    outline: none;
  }
  .input-effects:hover {
    content: "";
    background: transparent;
    border-color: blue;
    border-style: solid;
    border-width: 2px;
    transition: all 0.3s ease-in-out;
    mask-border: none;
  }
  .input-effects::placeholder {
    transform: translateY(4%);
  }
  textarea {
    field-sizing: content;
  }
</style>
